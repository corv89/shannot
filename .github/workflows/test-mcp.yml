name: MCP Server Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test-mcp:
    name: Test MCP Server (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    container:
      image: python:${{ matrix.python-version }}-slim
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12", "3.13"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y git curl

      - name: Install mcp-probe
        run: |
          # Detect architecture
          ARCH=$(uname -m)
          case $ARCH in
            x86_64)
              PLATFORM="x86_64-unknown-linux-gnu"
              ;;
            aarch64)
              PLATFORM="aarch64-unknown-linux-gnu"
              ;;
            *)
              echo "Unsupported architecture: $ARCH"
              exit 1
              ;;
          esac

          # Get latest version from GitHub API
          LATEST_VERSION=$(curl -s https://api.github.com/repos/conikeec/mcp-probe/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')

          if [ -z "$LATEST_VERSION" ]; then
            echo "Failed to get latest version, using v0.3.0"
            LATEST_VERSION="v0.3.0"
          fi

          echo "Installing mcp-probe ${LATEST_VERSION} for ${PLATFORM}"

          # Download and install
          DOWNLOAD_URL="https://github.com/conikeec/mcp-probe/releases/download/${LATEST_VERSION}/mcp-probe-${PLATFORM}.tar.gz"
          curl -L -o mcp-probe.tar.gz "$DOWNLOAD_URL"
          tar -xzf mcp-probe.tar.gz
          chmod +x mcp-probe
          mv mcp-probe /usr/local/bin/
          mcp-probe --version

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Verify shannot-mcp is installed
        run: |
          which shannot-mcp
          shannot-mcp --help

      - name: Run MCP protocol compliance tests
        run: |
          pytest test/test_mcp_integration.py -v --tb=short --junitxml=mcp-results.xml

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: mcp-test-results-py${{ matrix.python-version }}
          path: mcp-results.xml
          if-no-files-found: warn

  test-mcp-unit:
    name: MCP Unit Tests
    runs-on: ubuntu-latest
    container:
      image: python:3.11-slim

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install git
        run: |
          apt-get update
          apt-get install -y git

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run MCP unit tests
        run: |
          pytest test/test_mcp*.py -v --tb=short -m "not integration" --junitxml=mcp-unit-results.xml

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: mcp-unit-test-results
          path: mcp-unit-results.xml
          if-no-files-found: warn
