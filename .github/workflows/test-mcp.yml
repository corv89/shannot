name: MCP Server Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test-mcp:
    name: Test MCP Server (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    container:
      image: python:${{ matrix.python-version }}-slim
      options: --privileged
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y bubblewrap git curl
          bwrap --version

      - name: Install mcp-probe
        run: |
          # Detect architecture
          ARCH=$(uname -m)
          case $ARCH in
            x86_64)
              PLATFORM="x86_64-unknown-linux-gnu"
              ;;
            aarch64)
              PLATFORM="aarch64-unknown-linux-gnu"
              ;;
            *)
              echo "Unsupported architecture: $ARCH"
              exit 1
              ;;
          esac

          # Get latest version from GitHub API
          LATEST_VERSION=$(curl -s https://api.github.com/repos/conikeec/mcp-probe/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')

          if [ -z "$LATEST_VERSION" ]; then
            echo "Failed to get latest version, using v0.3.0"
            LATEST_VERSION="v0.3.0"
          fi

          echo "Installing mcp-probe ${LATEST_VERSION} for ${PLATFORM}"

          # Download and install
          DOWNLOAD_URL="https://github.com/conikeec/mcp-probe/releases/download/${LATEST_VERSION}/mcp-probe-${PLATFORM}.tar.gz"
          curl -L -o mcp-probe.tar.gz "$DOWNLOAD_URL"
          tar -xzf mcp-probe.tar.gz
          chmod +x mcp-probe
          mv mcp-probe /usr/local/bin/
          mcp-probe --version

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,mcp,remote]"

      - name: Verify shannot-mcp is installed
        run: |
          which shannot-mcp
          shannot-mcp --help

      - name: Run MCP tests
        run: |
          pytest test/ -v --tb=short -m integration --junitxml=mcp-results.xml

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mcp-test-results-py${{ matrix.python-version }}
          path: mcp-results.xml
          if-no-files-found: warn

  test-mcp-with-config:
    name: Test MCP Server with Config
    runs-on: ubuntu-latest
    container:
      image: python:3.11-slim
      options: --privileged

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y bubblewrap git curl
          bwrap --version

      - name: Install mcp-probe
        run: |
          # Detect architecture
          ARCH=$(uname -m)
          case $ARCH in
            x86_64)
              PLATFORM="x86_64-unknown-linux-gnu"
              ;;
            aarch64)
              PLATFORM="aarch64-unknown-linux-gnu"
              ;;
            *)
              echo "Unsupported architecture: $ARCH"
              exit 1
              ;;
          esac

          # Get latest version from GitHub API
          LATEST_VERSION=$(curl -s https://api.github.com/repos/conikeec/mcp-probe/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')

          if [ -z "$LATEST_VERSION" ]; then
            echo "Failed to get latest version, using v0.3.0"
            LATEST_VERSION="v0.3.0"
          fi

          echo "Installing mcp-probe ${LATEST_VERSION} for ${PLATFORM}"

          # Download and install
          DOWNLOAD_URL="https://github.com/conikeec/mcp-probe/releases/download/${LATEST_VERSION}/mcp-probe-${PLATFORM}.tar.gz"
          curl -L -o mcp-probe.tar.gz "$DOWNLOAD_URL"
          tar -xzf mcp-probe.tar.gz
          chmod +x mcp-probe
          mv mcp-probe /usr/local/bin/
          mcp-probe --version

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,mcp,remote]"

      - name: Create test config file
        run: |
          mkdir -p ~/.config/shannot
          cat > ~/.config/shannot/config.toml << 'EOF'
          default_executor = "local"

          [executor.local]
          type = "local"
          EOF

      - name: Test with local executor target
        run: |
          # Test that server starts with --target local
          timeout 30 shannot-mcp --target local &
          SERVER_PID=$!
          sleep 5
          kill $SERVER_PID || true
          echo "Server started successfully with --target local"

      - name: Run MCP tests
        run: |
          pytest test/ -v --tb=short -m integration --junitxml=mcp-results.xml

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mcp-test-results-with-config
          path: mcp-results.xml
          if-no-files-found: warn
